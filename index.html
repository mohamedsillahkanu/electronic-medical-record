<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHIS2 EMR System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background-color: #0d1117;
            color: #e6edf3;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .login-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 50px;
            width: 100%;
            max-width: 500px;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2ea043, #58a6ff, #7c3aed);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .login-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #8b949e;
            font-size: 14px;
        }

        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .role-btn {
            flex: 1;
            padding: 15px;
            background: #21262d;
            border: 2px solid #30363d;
            border-radius: 8px;
            color: #8b949e;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: 600;
        }

        .role-btn.active {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.1);
            color: #58a6ff;
        }

        .login-btn {
            width: 100%;
            padding: 20px 40px;
            background: linear-gradient(135deg, #2ea043 0%, #22c55e 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 20px rgba(46, 160, 67, 0.3);
            margin-top: 10px;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #22c55e 0%, #2ea043 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(46, 160, 67, 0.4);
        }

        .error-message {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid #f85149;
            color: #f85149;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Main Content */
        .main-content {
            display: none;
        }

        .main-content.show {
            display: block;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 10px;
        }

        .header p {
            color: #8b949e;
            font-size: 18px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-info {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #8b949e;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        .status-dot.online {
            background: #2ea043;
            box-shadow: 0 0 0 3px rgba(46, 160, 67, 0.3);
        }

        .status-dot.offline {
            background: #f85149;
            box-shadow: 0 0 0 3px rgba(248, 81, 73, 0.3);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .availability-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: #30363d;
            border-radius: 13px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #2ea043;
        }

        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(24px);
        }

        .logout-btn {
            background: transparent;
            color: #8b949e;
            border: 1px solid #30363d;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #30363d;
            border-color: #58a6ff;
            color: #e6edf3;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #30363d;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #8b949e;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
            font-size: 14px;
            white-space: nowrap;
        }

        .tab.active {
            color: #58a6ff;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #58a6ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2ea043, #58a6ff, #7c3aed);
        }

        .card-header {
            margin-bottom: 30px;
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            color: #58a6ff;
            margin-bottom: 5px;
        }

        .card-description {
            color: #8b949e;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #e6edf3;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .required {
            color: #f85149;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #e6edf3;
            font-size: 16px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .form-input:disabled,
        .form-select:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #161b22;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: #58a6ff;
            color: #ffffff;
            width: 100%;
        }

        .btn-primary:hover {
            background: #388bfd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-success {
            background: #2ea043;
            color: #ffffff;
        }

        .btn-success:hover {
            background: #22c55e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 160, 67, 0.3);
        }

        .patient-card {
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .patient-card:hover {
            border-color: #58a6ff;
            background: rgba(88, 166, 255, 0.05);
        }

        .patient-name {
            font-size: 18px;
            font-weight: 700;
            color: #e6edf3;
            margin-bottom: 8px;
        }

        .patient-details {
            color: #8b949e;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .patient-id-badge {
            background: #58a6ff;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-top: 8px;
            font-family: monospace;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .status-ready {
            background: #2ea043;
            color: white;
        }

        .duplicate-warning {
            background: rgba(248, 81, 73, 0.1);
            border: 2px solid #f85149;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .duplicate-warning h3 {
            color: #f85149;
            margin-bottom: 10px;
        }

        .org-tree {
            max-height: 300px;
            overflow-y: auto;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
        }

        .org-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            transition: background 0.2s;
        }

        .org-item:hover {
            background: #30363d;
        }

        .org-item.selected {
            background: #58a6ff;
            color: white;
        }

        .org-level-1 { padding-left: 12px; }
        .org-level-2 { padding-left: 24px; }
        .org-level-3 { padding-left: 36px; }
        .org-level-4 { padding-left: 48px; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            color: #8b949e;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .modal-close:hover {
            color: #e6edf3;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #161b22;
            border: 1px solid #30363d;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }

        .notification.show {
            display: flex;
        }

        .notification.success {
            border-left: 4px solid #2ea043;
        }

        .notification.error {
            border-left: 4px solid #f85149;
        }

        .notification.info {
            border-left: 4px solid #58a6ff;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #30363d;
            border-top: 4px solid #58a6ff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }

            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-header">
                <h1>DHIS2 EMR System</h1>
                <p>Select your role and login</p>
            </div>

            <div class="role-selector">
                <div class="role-btn active" onclick="selectRole('admin')" id="roleAdmin">
                    <div style="font-size: 24px; margin-bottom: 5px;">üë®‚Äçüíº</div>
                    <div>Admin/Receptionist</div>
                </div>
                <div class="role-btn" onclick="selectRole('doctor')" id="roleDoctor">
                    <div style="font-size: 24px; margin-bottom: 5px;">üë®‚Äç‚öïÔ∏è</div>
                    <div>Doctor</div>
                </div>
            </div>

            <div class="error-message" id="loginError">Invalid credentials</div>

            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="username" required autocomplete="username">
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="password" required autocomplete="current-password">
                </div>

                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container">
            <div class="status-bar">
                <div class="status-info">
                    <div class="status-indicator">
                        <span id="currentUserDisplay"></span>
                    </div>
                    <div class="availability-toggle" id="availabilityToggle" style="display: none;">
                        <span style="color: #8b949e; font-size: 14px;">Available:</span>
                        <div class="toggle-switch" id="availabilitySwitch">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="status-indicator">
                        <span class="status-dot" id="dhisStatusDot"></span>
                        <span id="dhisStatusText">Connecting to DHIS2...</span>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>

            <div class="header">
                <h1>Electronic Medical Record System</h1>
                <p>DHIS2 Integrated</p>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="search">Search Patient</button>
                <button class="tab" data-tab="register" id="registerTab">New Patient</button>
                <button class="tab" data-tab="consultations" id="consultationsTab">All Patients</button>
                <button class="tab" data-tab="doctor" id="doctorTab" style="display: none;">My Patients</button>
            </div>

            <!-- Search Tab -->
            <div class="tab-content active" data-content="search">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Search Patient by ID</h2>
                        <p class="card-description">Enter the patient ID to find records</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Patient ID</label>
                        <input type="text" class="form-input" id="searchPatientID" placeholder="e.g., mohamed_02121995_099177283">
                    </div>

                    <button class="btn btn-primary" id="searchBtn">Search</button>

                    <div id="searchResults" style="margin-top: 30px;"></div>
                </div>
            </div>

            <!-- Register Tab -->
            <div class="tab-content" data-content="register">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Register New Patient</h2>
                        <p class="card-description">Enter patient ID or complete information</p>
                    </div>

                    <div id="duplicateWarning"></div>

                    <form id="patientForm">
                        <!-- Patient ID Lookup Section -->
                        <div style="background: #21262d; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                            <h3 style="color: #58a6ff; margin-bottom: 15px;">Existing Patient?</h3>
                            <p style="color: #8b949e; font-size: 14px; margin-bottom: 15px;">Enter Patient ID to auto-populate information</p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Patient ID</label>
                                    <input type="text" class="form-input" id="patientIdLookup" placeholder="e.g., mohamed_02121995_099177283">
                                </div>
                                <div style="display: flex; align-items: flex-end;">
                                    <button type="button" class="btn btn-primary" id="lookupBtn" style="width: 100%;">Load Patient</button>
                                </div>
                            </div>
                        </div>

                        <h3 style="color: #58a6ff; margin-bottom: 20px;">Demographics</h3>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">First Name <span class="required">*</span></label>
                                <input type="text" class="form-input" name="firstName" id="firstName" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Middle Name</label>
                                <input type="text" class="form-input" name="middleName" id="middleName">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name <span class="required">*</span></label>
                                <input type="text" class="form-input" name="lastName" id="lastName" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Date of Birth <span class="required">*</span></label>
                                <input type="date" class="form-input" name="dob" id="dob" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender <span class="required">*</span></label>
                                <select class="form-select" name="gender" id="gender" required>
                                    <option value="">Select gender...</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Phone Number <span class="required">*</span></label>
                                <input type="tel" class="form-input" name="phone" id="phone" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" name="email" id="email">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Address <span class="required">*</span></label>
                            <input type="text" class="form-input" name="address" id="address" required>
                        </div>

                        <h3 style="color: #58a6ff; margin: 30px 0 20px;">Organization Unit <span class="required">*</span></h3>

                        <div class="form-group">
                            <label class="form-label">Select Health Facility</label>
                            <input type="text" class="form-input" id="orgUnitSearch" placeholder="Type to search...">
                            <div class="org-tree" id="orgUnitTree"></div>
                            <input type="hidden" name="orgUnit" id="selectedOrgUnit" required>
                        </div>

                        <h3 style="color: #58a6ff; margin: 30px 0 20px;">Emergency Contact</h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Contact Name</label>
                                <input type="text" class="form-input" name="emergencyContact" id="emergencyContact">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Contact Phone</label>
                                <input type="tel" class="form-input" name="emergencyPhone" id="emergencyPhone">
                            </div>
                        </div>

                        <h3 style="color: #58a6ff; margin: 30px 0 20px;">Vital Signs</h3>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">Temperature (¬∞C)</label>
                                <input type="number" step="0.1" class="form-input" name="temperature">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Blood Pressure</label>
                                <input type="text" class="form-input" name="bloodPressure" placeholder="120/80">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pulse (bpm)</label>
                                <input type="number" class="form-input" name="pulse">
                            </div>
                        </div>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">Weight (kg)</label>
                                <input type="number" step="0.1" class="form-input" name="weight">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Height (cm)</label>
                                <input type="number" class="form-input" name="height">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Respiratory Rate</label>
                                <input type="number" class="form-input" name="respiratoryRate">
                            </div>
                        </div>

                        <h3 style="color: #58a6ff; margin: 30px 0 20px;">Clinical Information</h3>

                        <div class="form-group">
                            <label class="form-label">Specialty / Department <span class="required">*</span></label>
                            <select class="form-select" name="specialty" id="specialty" required>
                                <option value="">Select specialty...</option>
                                <option value="General Medicine">General Medicine</option>
                                <option value="Pediatrics">Pediatrics</option>
                                <option value="Surgery">Surgery</option>
                                <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                                <option value="Internal Medicine">Internal Medicine</option>
                            </select>
                        </div>

                        <div id="doctorAssignment"></div>

                        <div class="form-group">
                            <label class="form-label">Chief Complaint</label>
                            <input type="text" class="form-input" name="chiefComplaint">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Diagnosis</label>
                            <input type="text" class="form-input" name="diagnosis">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Treatment/Prescription</label>
                            <textarea class="form-textarea" name="treatment" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Clinical Notes</label>
                            <textarea class="form-textarea" name="notes" rows="3"></textarea>
                        </div>

                        <input type="hidden" name="existingPatientId" id="existingPatientId">

                        <button type="submit" class="btn btn-success" style="width: 100%;">Register Patient</button>
                    </form>
                </div>
            </div>

            <!-- All Patients Tab -->
            <div class="tab-content" data-content="consultations">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Patients</h2>
                        <p class="card-description">System-wide patient records</p>
                    </div>
                    <div id="consultationsList"></div>
                </div>
            </div>

            <!-- Doctor Dashboard -->
            <div class="tab-content" data-content="doctor">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">My Patients</h2>
                        <p class="card-description">Patients assigned to you</p>
                    </div>
                    <div id="doctorDashboard"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div class="modal" id="statusModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <div id="statusModalContent"></div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText"></span>
    </div>

    <script>
        // Doctor credentials
        const DOCTORS = {
            'dr.smith': {
                password: 'doctor123',
                name: 'Dr. John Smith',
                specialty: 'General Medicine',
                available: true
            },
            'dr.johnson': {
                password: 'doctor123',
                name: 'Dr. Sarah Johnson',
                specialty: 'Pediatrics',
                available: true
            },
            'dr.williams': {
                password: 'doctor123',
                name: 'Dr. Michael Williams',
                specialty: 'Surgery',
                available: false
            },
            'dr.brown': {
                password: 'doctor123',
                name: 'Dr. Emily Brown',
                specialty: 'Obstetrics & Gynecology',
                available: true
            },
            'dr.davis': {
                password: 'doctor123',
                name: 'Dr. David Davis',
                specialty: 'Internal Medicine',
                available: true
            }
        };

        // DHIS2 Configuration
        const DHIS2 = {
            baseUrl: '',
            currentUser: null,
            orgUnits: [],
            programId: '',
            trackedEntityType: '',
            attributes: {},
            dataElements: {}
        };

        // State Management
        const state = {
            patients: new Map(),
            consultations: new Map(),
            selectedOrgUnit: null,
            filteredOrgUnits: [],
            currentUserType: null,
            currentUserName: null,
            selectedRole: 'admin'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            checkLoginState();
            setupEventListeners();
        });

        function selectRole(role) {
            state.selectedRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('role' + role.charAt(0).toUpperCase() + role.slice(1)).classList.add('active');
        }

        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('patientForm').addEventListener('submit', registerPatient);
            document.getElementById('searchBtn').addEventListener('click', searchPatient);
            document.getElementById('lookupBtn').addEventListener('click', loadPatientById);
            document.getElementById('availabilitySwitch')?.addEventListener('click', toggleAvailability);
            document.getElementById('specialty').addEventListener('change', handleSpecialtyChange);

            // Real-time search
            document.getElementById('searchPatientID').addEventListener('input', searchPatient);
            document.getElementById('orgUnitSearch').addEventListener('input', (e) => {
                searchOrgUnits(e.target.value);
            });

            // Check for duplicate on blur
            ['firstName', 'lastName', 'dob', 'phone'].forEach(id => {
                document.getElementById(id).addEventListener('blur', checkDuplicate);
            });

            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    tab.classList.add('active');
                    document.querySelector(`[data-content="${tab.dataset.tab}"]`).classList.add('active');

                    if (tab.dataset.tab === 'consultations') {
                        loadConsultations();
                    } else if (tab.dataset.tab === 'doctor') {
                        loadDoctorDashboard();
                    }
                });
            });
        }

        function checkLoginState() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn') === 'true';
            const userType = sessionStorage.getItem('userType');
            const userName = sessionStorage.getItem('userName');

            if (isLoggedIn) {
                state.currentUserType = userType;
                state.currentUserName = userName;
                showMainContent();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = state.selectedRole;

            if (role === 'admin') {
                if (username === 'admin' && password === 'admin') {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('userType', 'admin');
                    sessionStorage.setItem('userName', 'Administrator');
                    state.currentUserType = 'admin';
                    state.currentUserName = 'Administrator';
                    await showMainContent();
                    return;
                }
            } else if (role === 'doctor') {
                if (DOCTORS[username] && DOCTORS[username].password === password) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('userType', 'doctor');
                    sessionStorage.setItem('userName', username);
                    state.currentUserType = 'doctor';
                    state.currentUserName = username;
                    await showMainContent();
                    return;
                }
            }

            document.getElementById('loginError').classList.add('show');
            setTimeout(() => {
                document.getElementById('loginError').classList.remove('show');
            }, 3000);
        }

        function handleLogout() {
            sessionStorage.clear();
            location.reload();
        }

        async function showMainContent() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').classList.add('show');

            if (state.currentUserType === 'doctor') {
                const doctorInfo = DOCTORS[state.currentUserName];
                document.getElementById('currentUserDisplay').textContent = doctorInfo.name;
                document.getElementById('doctorTab').style.display = 'block';
                document.getElementById('availabilityToggle').style.display = 'flex';
                
                const availSwitch = document.getElementById('availabilitySwitch');
                if (doctorInfo.available) {
                    availSwitch.classList.add('active');
                }

                // Hide admin tabs
                document.getElementById('registerTab').style.display = 'none';
                document.getElementById('consultationsTab').style.display = 'none';

                // Switch to doctor tab
                switchTab('doctor');
            } else {
                document.getElementById('currentUserDisplay').textContent = 'Administrator';
                document.getElementById('doctorTab').style.display = 'none';
                document.getElementById('availabilityToggle').style.display = 'none';
            }

            await initializeDHIS2();
            loadFromLocalStorage();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
            document.querySelector(`[data-content="${tabName}"]`)?.classList.add('active');

            if (tabName === 'doctor') {
                loadDoctorDashboard();
            } else if (tabName === 'consultations') {
                loadConsultations();
            }
        }

        function toggleAvailability() {
            const switchEl = document.getElementById('availabilitySwitch');
            switchEl.classList.toggle('active');
            DOCTORS[state.currentUserName].available = switchEl.classList.contains('active');
            
            saveDoctorAvailability();
            
            const status = switchEl.classList.contains('active') ? 'Available' : 'Unavailable';
            showNotification(`Status updated to: ${status}`, 'success');
        }

        function saveDoctorAvailability() {
            localStorage.setItem('doctors', JSON.stringify(DOCTORS));
        }

        function loadDoctorAvailability() {
            const saved = localStorage.getItem('doctors');
            if (saved) {
                try {
                    const savedDoctors = JSON.parse(saved);
                    Object.assign(DOCTORS, savedDoctors);
                } catch (error) {
                    console.error('Error loading doctor availability:', error);
                }
            }
        }

        async function initializeDHIS2() {
            try {
                DHIS2.baseUrl = window.location.origin + '/api';
                
                const user = await fetchDHIS2('/me').catch(() => ({ name: 'Local User' }));
                DHIS2.currentUser = user;

                await loadOrganizationUnits();

                document.getElementById('dhisStatusDot').className = 'status-dot online';
                document.getElementById('dhisStatusText').textContent = 'DHIS2 Connected';

                showNotification('System ready', 'success');

            } catch (error) {
                console.error('DHIS2 initialization error:', error);
                document.getElementById('dhisStatusDot').className = 'status-dot offline';
                document.getElementById('dhisStatusText').textContent = 'Using Local Storage';
            }
        }

        async function fetchDHIS2(endpoint, options = {}) {
            const url = DHIS2.baseUrl + endpoint;
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            };

            const response = await fetch(url, { ...defaultOptions, ...options });
            
            if (!response.ok) {
                throw new Error(`DHIS2 API error: ${response.statusText}`);
            }

            return await response.json();
        }

        async function loadOrganizationUnits() {
            try {
                const response = await fetchDHIS2('/organisationUnits.json?fields=id,name,level,parent[id,name]&paging=false');
                DHIS2.orgUnits = response.organisationUnits;

                const orgUnitTree = buildOrgUnitTree(DHIS2.orgUnits);
                renderOrgUnitTree(orgUnitTree);

                state.filteredOrgUnits = DHIS2.orgUnits;

            } catch (error) {
                console.error('Error loading org units:', error);
                // Use mock data
                DHIS2.orgUnits = [
                    { id: 'OU1', name: 'Bo Government Hospital', level: 1 },
                    { id: 'OU2', name: 'Makeni Government Hospital', level: 1 },
                    { id: 'OU3', name: 'Kenema Government Hospital', level: 1 }
                ];
                renderOrgUnitTree(DHIS2.orgUnits);
            }
        }

        function buildOrgUnitTree(orgUnits) {
            const tree = [];
            const map = new Map();

            orgUnits.forEach(ou => {
                map.set(ou.id, { ...ou, children: [] });
            });

            orgUnits.forEach(ou => {
                const node = map.get(ou.id);
                if (ou.parent) {
                    const parent = map.get(ou.parent.id);
                    if (parent) {
                        parent.children.push(node);
                    } else {
                        tree.push(node);
                    }
                } else {
                    tree.push(node);
                }
            });

            return tree;
        }

        function renderOrgUnitTree(tree, container = document.getElementById('orgUnitTree'), level = 1) {
            if (level === 1) {
                container.innerHTML = '';
            }

            tree.forEach(node => {
                const div = document.createElement('div');
                div.className = `org-item org-level-${level}`;
                div.textContent = node.name;
                div.dataset.id = node.id;
                div.dataset.name = node.name;

                div.addEventListener('click', function(e) {
                    e.stopPropagation();
                    selectOrgUnit(node.id, node.name);
                });

                container.appendChild(div);

                if (node.children && node.children.length > 0) {
                    renderOrgUnitTree(node.children, container, level + 1);
                }
            });
        }

        function selectOrgUnit(id, name) {
            state.selectedOrgUnit = { id, name };
            document.getElementById('selectedOrgUnit').value = id;

            document.querySelectorAll('.org-item').forEach(item => {
                item.classList.remove('selected');
            });
            document.querySelector(`[data-id="${id}"]`)?.classList.add('selected');

            showNotification(`Selected: ${name}`, 'info');
        }

        function searchOrgUnits(searchTerm) {
            const filtered = DHIS2.orgUnits.filter(ou => 
                ou.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            state.filteredOrgUnits = filtered;

            const container = document.getElementById('orgUnitTree');
            container.innerHTML = '';

            if (filtered.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #8b949e;">No facilities found</div>';
                return;
            }

            filtered.forEach(ou => {
                const div = document.createElement('div');
                div.className = 'org-item';
                div.textContent = ou.name;
                div.dataset.id = ou.id;
                div.dataset.name = ou.name;

                div.addEventListener('click', function() {
                    selectOrgUnit(ou.id, ou.name);
                });

                container.appendChild(div);
            });
        }

        function generatePatientId(firstName, dob, phone) {
            const namePart = firstName.toLowerCase().replace(/[^a-z]/g, '');
            const dobParts = dob.split('-'); // YYYY-MM-DD
            const dobPart = dobParts[2] + dobParts[1] + dobParts[0]; // DDMMYYYY
            const phonePart = phone.replace(/[^0-9]/g, '');
            return `${namePart}_${dobPart}_${phonePart}`;
        }

        async function checkDuplicate() {
            const firstName = document.getElementById('firstName').value.trim().toLowerCase();
            const lastName = document.getElementById('lastName').value.trim().toLowerCase();
            const dob = document.getElementById('dob').value;
            const phone = document.getElementById('phone').value.trim();

            if (!firstName || !lastName || !dob || !phone) {
                return;
            }

            const duplicate = Array.from(state.patients.values()).find(patient => 
                patient.firstName?.toLowerCase() === firstName &&
                patient.lastName?.toLowerCase() === lastName &&
                patient.dob === dob &&
                patient.phone === phone
            );

            const warningDiv = document.getElementById('duplicateWarning');

            if (duplicate) {
                warningDiv.innerHTML = `
                    <div class="duplicate-warning">
                        <h3>‚ö†Ô∏è Duplicate Patient Found</h3>
                        <p style="color: #8b949e; margin: 10px 0;">A patient with this information already exists:</p>
                        <div style="background: #21262d; padding: 15px; border-radius: 6px; margin: 15px 0;">
                            <div style="color: #e6edf3; font-weight: 600; margin-bottom: 5px;">${duplicate.firstName} ${duplicate.lastName}</div>
                            <div style="color: #58a6ff; font-family: monospace;">${duplicate.patientId}</div>
                        </div>
                        <p style="color: #f85149; font-weight: 600;">Please use the existing Patient ID above or verify the information is correct.</p>
                    </div>
                `;
            } else {
                warningDiv.innerHTML = '';
            }
        }

        async function loadPatientById() {
            const patientId = document.getElementById('patientIdLookup').value.trim();

            if (!patientId) {
                showNotification('Please enter a Patient ID', 'error');
                return;
            }

            const patient = state.patients.get(patientId);

            if (!patient) {
                showNotification('Patient not found', 'error');
                return;
            }

            // Populate form fields
            document.getElementById('firstName').value = patient.firstName || '';
            document.getElementById('middleName').value = patient.middleName || '';
            document.getElementById('lastName').value = patient.lastName || '';
            document.getElementById('dob').value = patient.dob || '';
            document.getElementById('gender').value = patient.gender || '';
            document.getElementById('phone').value = patient.phone || '';
            document.getElementById('email').value = patient.email || '';
            document.getElementById('address').value = patient.address || '';
            document.getElementById('emergencyContact').value = patient.emergencyContact || '';
            document.getElementById('emergencyPhone').value = patient.emergencyPhone || '';
            document.getElementById('existingPatientId').value = patientId;

            // Disable demographic fields
            ['firstName', 'middleName', 'lastName', 'dob', 'gender', 'phone', 'email', 'address'].forEach(id => {
                document.getElementById(id).disabled = true;
            });

            if (patient.orgUnit && patient.orgUnitName) {
                selectOrgUnit(patient.orgUnit, patient.orgUnitName);
            }

            showNotification('Patient information loaded - Add new consultation details', 'success');
        }

        function handleSpecialtyChange(e) {
            const specialty = e.target.value;
            const container = document.getElementById('doctorAssignment');

            if (!specialty) {
                container.innerHTML = '';
                return;
            }

            const availableDoctors = Object.entries(DOCTORS)
                .filter(([_, doc]) => doc.specialty === specialty && doc.available)
                .map(([username, doc]) => ({ username, ...doc }));

            if (availableDoctors.length === 0) {
                container.innerHTML = `
                    <div style="background: rgba(248, 81, 73, 0.1); border: 1px solid #f85149; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <p style="color: #f85149; margin: 0;">No doctors available in ${specialty}. Patient will be added to waiting list.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Available Doctors <span class="required">*</span></label>
                    <select class="form-select" name="assignedDoctor" required>
                        <option value="">Select doctor...</option>
                        ${availableDoctors.map(doc => 
                            `<option value="${doc.username}">${doc.name}</option>`
                        ).join('')}
                    </select>
                </div>
            `;
        }

        async function registerPatient(e) {
            e.preventDefault();
            const formData = new FormData(e.target);

            const firstName = formData.get('firstName');
            const dob = formData.get('dob');
            const phone = formData.get('phone');
            const existingPatientId = formData.get('existingPatientId');

            const patientId = existingPatientId || generatePatientId(firstName, dob, phone);

            // Check for duplicates (only for new registrations)
            if (!existingPatientId) {
                const lastName = formData.get('lastName');
                const duplicate = Array.from(state.patients.values()).find(patient => 
                    patient.firstName?.toLowerCase() === firstName.toLowerCase() &&
                    patient.lastName?.toLowerCase() === lastName.toLowerCase() &&
                    patient.dob === dob &&
                    patient.phone === phone
                );

                if (duplicate) {
                    showNotification('Duplicate patient! Patient ID: ' + duplicate.patientId, 'error');
                    return;
                }
            }

            const consultationId = generateConsultationId();
            const assignedDoctor = formData.get('assignedDoctor');

            const consultationData = {
                consultationId: consultationId,
                patientId: patientId,
                timestamp: new Date().toISOString(),
                orgUnit: formData.get('orgUnit'),
                orgUnitName: state.selectedOrgUnit?.name,
                specialty: formData.get('specialty'),
                assignedDoctor: assignedDoctor ? DOCTORS[assignedDoctor].name : null,
                assignedDoctorUsername: assignedDoctor,
                consultationStatus: assignedDoctor ? 'pending' : 'waiting',
                temperature: formData.get('temperature'),
                bloodPressure: formData.get('bloodPressure'),
                pulse: formData.get('pulse'),
                weight: formData.get('weight'),
                height: formData.get('height'),
                respiratoryRate: formData.get('respiratoryRate'),
                chiefComplaint: formData.get('chiefComplaint'),
                diagnosis: formData.get('diagnosis'),
                treatment: formData.get('treatment'),
                notes: formData.get('notes')
            };

            // Store consultation
            state.consultations.set(consultationId, consultationData);

            // Store or update patient
            if (!state.patients.has(patientId)) {
                const patientData = {
                    patientId: patientId,
                    firstName: firstName,
                    middleName: formData.get('middleName'),
                    lastName: formData.get('lastName'),
                    dob: dob,
                    gender: formData.get('gender'),
                    phone: phone,
                    email: formData.get('email'),
                    address: formData.get('address'),
                    emergencyContact: formData.get('emergencyContact'),
                    emergencyPhone: formData.get('emergencyPhone'),
                    orgUnit: formData.get('orgUnit'),
                    orgUnitName: state.selectedOrgUnit?.name,
                    registrationDate: new Date().toISOString()
                };
                state.patients.set(patientId, patientData);
            }

            saveToLocalStorage();

            showNotification(existingPatientId ? 'New consultation registered!' : 'Patient registered successfully!', 'success');

            if (!existingPatientId) {
                await generatePatientCard(state.patients.get(patientId));
            }

            showPatientStatus(consultationData);

            // Reset form
            e.target.reset();
            state.selectedOrgUnit = null;
            document.getElementById('duplicateWarning').innerHTML = '';
            document.getElementById('doctorAssignment').innerHTML = '';
            document.getElementById('existingPatientId').value = '';
            
            // Re-enable fields
            ['firstName', 'middleName', 'lastName', 'dob', 'gender', 'phone', 'email', 'address'].forEach(id => {
                document.getElementById(id).disabled = false;
            });
        }

        function generateConsultationId() {
            const timestamp = new Date().getTime();
            const random = Math.floor(Math.random() * 1000);
            return `CONS-${timestamp}-${random}`;
        }

        async function searchPatient() {
            const patientId = document.getElementById('searchPatientID').value.trim();

            if (!patientId) {
                document.getElementById('searchResults').innerHTML = '';
                return;
            }

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><p>Searching...</p></div>';

            setTimeout(() => {
                const patient = state.patients.get(patientId);

                if (!patient) {
                    resultsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #8b949e;">Patient not found</div>';
                    return;
                }

                // Get consultations for this patient
                const consultations = Array.from(state.consultations.values())
                    .filter(c => c.patientId === patientId)
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                resultsContainer.innerHTML = `
                    <div class="patient-card">
                        <div class="patient-name">${patient.firstName} ${patient.lastName}</div>
                        <div class="patient-id-badge">${patient.patientId}</div>
                        <div class="patient-details">DOB: ${patient.dob}</div>
                        <div class="patient-details">Phone: ${patient.phone}</div>
                        <div class="patient-details">Gender: ${patient.gender}</div>
                        <div class="patient-details">Facility: ${patient.orgUnitName || 'N/A'}</div>
                        
                        <h4 style="color: #58a6ff; margin-top: 20px; margin-bottom: 10px;">Consultations (${consultations.length})</h4>
                        ${consultations.map(c => `
                            <div style="background: #21262d; padding: 15px; border-radius: 6px; margin-bottom: 10px;">
                                <div style="color: #8b949e; font-size: 12px;">${new Date(c.timestamp).toLocaleString()}</div>
                                <div style="margin-top: 8px;">
                                    <span class="status-badge ${c.consultationStatus === 'ready' ? 'status-ready' : c.consultationStatus === 'pending' ? 'status-pending' : 'status-waiting'}">
                                        ${c.consultationStatus.toUpperCase()}
                                    </span>
                                </div>
                                <div style="color: #e6edf3; margin-top: 8px;">Specialty: ${c.specialty}</div>
                                ${c.assignedDoctor ? `<div style="color: #8b949e;">Doctor: ${c.assignedDoctor}</div>` : ''}
                                ${c.chiefComplaint ? `<div style="color: #8b949e;">Complaint: ${c.chiefComplaint}</div>` : ''}
                            </div>
                        `).join('')}

                        <button class="btn btn-primary" onclick='viewPatient(${JSON.stringify(patient).replace(/'/g, "\\'")})'style="margin-top: 15px; width: auto;">
                            View Full Record
                        </button>
                    </div>
                `;
            }, 500);
        }

        function viewPatient(patient) {
            showPatientStatus(patient);
        }

        function showPatientStatus(data) {
            const modal = document.getElementById('statusModal');
            const content = document.getElementById('statusModalContent');

            const isConsultation = data.consultationId !== undefined;

            content.innerHTML = `
                <h2 style="color: #58a6ff; margin-bottom: 20px;">${isConsultation ? 'Consultation Status' : 'Patient Record'}</h2>

                ${isConsultation && data.consultationStatus ? `
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: inline-block; padding: 20px 40px; background: ${
                        data.consultationStatus === 'ready' ? '#2ea043' :
                        data.consultationStatus === 'pending' ? '#f59e0b' : '#8b949e'
                    }; border-radius: 12px;">
                        <div style="font-size: 14px; color: rgba(255,255,255,0.8); margin-bottom: 5px;">Status</div>
                        <div style="font-size: 24px; font-weight: bold; color: white;">
                            ${data.consultationStatus === 'ready' ? 'READY FOR CONSULTATION' :
                              data.consultationStatus === 'pending' ? 'PENDING DOCTOR ACCEPTANCE' : 'WAITING FOR DOCTOR'}
                        </div>
                    </div>
                </div>
                ` : ''}

                <div style="background: #21262d; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <div style="margin-bottom: 15px;">
                        <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">Patient ID</div>
                        <div style="color: #58a6ff; font-size: 16px; font-family: monospace;">${data.patientId}</div>
                    </div>
                    ${isConsultation && data.assignedDoctor ? `
                    <div style="margin-bottom: 15px;">
                        <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">Assigned Doctor</div>
                        <div style="color: #e6edf3;">${data.assignedDoctor}</div>
                    </div>
                    ` : ''}
                    ${data.orgUnitName ? `
                    <div>
                        <div style="color: #8b949e; font-size: 12px; margin-bottom: 5px;">Health Facility</div>
                        <div style="color: #e6edf3;">${data.orgUnitName}</div>
                    </div>
                    ` : ''}
                </div>

                <button class="btn btn-primary" onclick="closeModal()">Close</button>
            `;

            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('statusModal').classList.remove('show');
        }

        async function generatePatientCard(patientData) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const qrCanvas = document.createElement('canvas');
            await QRCode.toCanvas(qrCanvas, patientData.patientId, {
                width: 150,
                margin: 2
            });
            const qrDataUrl = qrCanvas.toDataURL();

            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('PATIENT IDENTIFICATION CARD', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Electronic Medical Record System', 105, 30, { align: 'center' });

            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text(`${patientData.firstName} ${patientData.lastName}`, 20, 60);

            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');

            let yPos = 75;
            const fields = [
                ['Patient ID:', patientData.patientId],
                ['DOB:', patientData.dob],
                ['Gender:', patientData.gender],
                ['Phone:', patientData.phone],
                ['Facility:', patientData.orgUnitName || 'N/A']
            ];

            fields.forEach(([label, value]) => {
                doc.setFont(undefined, 'bold');
                doc.text(label, 20, yPos);
                doc.setFont(undefined, 'normal');
                doc.text(value || 'N/A', 60, yPos);
                yPos += 8;
            });

            doc.addImage(qrDataUrl, 'PNG', 140, 50, 50, 50);
            doc.setFontSize(8);
            doc.text('Scan for details', 165, 108, { align: 'center' });

            doc.save(`Patient_Card_${patientData.patientId}.pdf`);
            showNotification('Patient card downloaded', 'success');
        }

        function loadDoctorDashboard() {
            const container = document.getElementById('doctorDashboard');
            
            const myConsultations = Array.from(state.consultations.values())
                .filter(c => c.assignedDoctorUsername === state.currentUserName)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const pending = myConsultations.filter(c => c.consultationStatus === 'pending');
            const ready = myConsultations.filter(c => c.consultationStatus === 'ready');

            if (myConsultations.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #8b949e;">No patients assigned</div>';
                return;
            }

            let html = `<div style="margin-bottom: 20px;">
                <p style="color: #8b949e;">You have ${pending.length} pending consultation request(s)</p>
            </div>`;

            if (pending.length > 0) {
                html += '<h3 style="color: #f59e0b; margin-bottom: 15px;">Pending Requests</h3>';
                pending.forEach(consultation => {
                    const patient = state.patients.get(consultation.patientId);
                    html += `
                        <div class="patient-card" style="border-left: 4px solid #f59e0b;">
                            <div class="patient-name">${patient?.firstName} ${patient?.lastName}</div>
                            <div class="patient-id-badge">${consultation.patientId}</div>
                            <div class="patient-details">Phone: ${patient?.phone}</div>
                            <div class="patient-details">Specialty: ${consultation.specialty}</div>
                            ${consultation.chiefComplaint ? `<div class="patient-details">Complaint: ${consultation.chiefComplaint}</div>` : ''}
                            <button class="btn btn-success" onclick="acceptConsultation('${consultation.consultationId}')" style="margin-top: 15px;">
                                Accept Consultation
                            </button>
                        </div>
                    `;
                });
            }

            if (ready.length > 0) {
                html += '<h3 style="color: #2ea043; margin: 30px 0 15px;">Accepted Consultations</h3>';
                ready.forEach(consultation => {
                    const patient = state.patients.get(consultation.patientId);
                    html += `
                        <div class="patient-card" style="border-left: 4px solid #2ea043;">
                            <div class="patient-name">${patient?.firstName} ${patient?.lastName}</div>
                            <div class="patient-id-badge">${consultation.patientId}</div>
                            <div class="patient-details">Phone: ${patient?.phone}</div>
                            <span class="status-badge status-ready">READY</span>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function acceptConsultation(consultationId) {
            if (!confirm('Accept this consultation request?')) return;

            const consultation = state.consultations.get(consultationId);
            if (consultation) {
                consultation.consultationStatus = 'ready';
                state.consultations.set(consultationId, consultation);
                saveToLocalStorage();
                
                showNotification('Consultation accepted!', 'success');
                loadDoctorDashboard();
            }
        }

        function loadConsultations() {
            const container = document.getElementById('consultationsList');
            const consultations = Array.from(state.consultations.values())
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            if (consultations.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #8b949e;">No patients registered</div>';
                return;
            }

            container.innerHTML = consultations.map(consultation => {
                const patient = state.patients.get(consultation.patientId);
                return `
                    <div class="patient-card">
                        <div class="patient-name">${patient?.firstName} ${patient?.lastName}</div>
                        <div class="patient-id-badge">${consultation.patientId}</div>
                        <div class="patient-details">Facility: ${consultation.orgUnitName || 'N/A'}</div>
                        <div class="patient-details">Date: ${new Date(consultation.timestamp).toLocaleString()}</div>
                        <div class="patient-details">Specialty: ${consultation.specialty}</div>
                        ${consultation.assignedDoctor ? `<div class="patient-details">Doctor: ${consultation.assignedDoctor}</div>` : ''}
                        <div style="margin-top: 10px;">
                            <span class="status-badge ${
                                consultation.consultationStatus === 'ready' ? 'status-ready' :
                                consultation.consultationStatus === 'pending' ? 'status-pending' : 'status-waiting'
                            }">
                                ${consultation.consultationStatus.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function saveToLocalStorage() {
            localStorage.setItem('emr_patients', JSON.stringify(Array.from(state.patients.entries())));
            localStorage.setItem('emr_consultations', JSON.stringify(Array.from(state.consultations.entries())));
        }

        function loadFromLocalStorage() {
            loadDoctorAvailability();

            const savedPatients = localStorage.getItem('emr_patients');
            if (savedPatients) {
                try {
                    const entries = JSON.parse(savedPatients);
                    state.patients = new Map(entries);
                } catch (error) {
                    console.error('Error loading patients:', error);
                }
            }

            const savedConsultations = localStorage.getItem('emr_consultations');
            if (savedConsultations) {
                try {
                    const entries = JSON.parse(savedConsultations);
                    state.consultations = new Map(entries);
                } catch (error) {
                    console.error('Error loading consultations:', error);
                }
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');

            notification.className = `notification ${type} show`;
            text.textContent = message;

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>
